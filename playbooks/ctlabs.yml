---

# -----------------------------------------------------------------------------------------------------------
# File        : ctlabs-ansible/playbooks/lab07.yml
# Description : setup monitoring stack (prometheus, grafana, node_exporter, syslogng, loki)
# -----------------------------------------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# ctlabs setup
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.setup
  hosts : all
  tags  : setup
  tasks :
    - name: ctlabs.playbooks.ctlabs.setup.local_facts.dir
      file:
        path : /etc/ansible/facts.d
        state: directory

    - name: ctlabs.playbooks.ctlabs.setup.bind.master.local_facts
      when: ansible_hostname == 'ns1'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_bind.fact
        content: |
          {
            "type"   : "master",
            "zones"  : [
              { "name" : "ctlabs.internal" }, 
              { "name" : "net03.ctlabs.internal" }, 
              { "name" : "svc.ctlabs.internal", "ddns" : { "allow" : [ "127.0.0.1" ] } }
            ],
            "slaves" : [ "192.168.20.11" ]
          }

    - name: ctlabs.playbooks.ctlabs.setup.bind.slave.local_facts
      when: ansible_hostname == 'ns2'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_bind.fact
        content: |
          {
            "type"    : "slave",
            "zones"  : [
              { "name" : "ctlabs.internal" }, 
              { "name" : "net03.ctlabs.internal" }, 
              { "name" : "svc.ctlabs.internal", "ddns" : { "allow" : [ "127.0.0.1" ] } } 
            ],
            "masters" : [ "192.168.10.11" ]
          }

    - name: ctlabs.playbooks.ctlabs.smbadc.local_facts
      when: ansible_hostname in [ 'dc1', 'dc2' ]
      copy:
        dest: /etc/ansible/facts.d/ctlabs_smbadc.fact
        content: |
          {
            "type"   : "master",
            "domain" : "ctlabs.internal"
          }

    - name: ctlabs.playbooks.ctlabs.prometheus.local_facts
      when: ansible_hostname == 'prometheus'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_prometheus.fact
        content: |
          {
            "mode"   : "agent",
            "config" : {
              "node_exporter" : true,
              "remote_write"  : {
                "uri" : "http://mimir.ctlabs.internal:9009/api/v1/push"
              }
            }
          }

    - name: ctlabs.playbooks.ctlabs.setup.openvpn.server.local_facts
      when: ansible_hostname == 'ro1'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_openvpn.fact
        content: |
          {
            "type"      : "server",
            "server_ip" : "10.8.15.1",
            "client_ip" : "10.8.15.2"
          }

    - name: ctlabs.playbooks.ctlabs.setup.openvpn.client.local_facts
      when: ansible_hostname == 'ro2'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_openvpn.fact
        content: |
          {
            "type"      : "client",
            "server_ip" : "10.8.15.1",
            "client_ip" : "10.8.15.2",
            "remote"    : "192.168.16.2"
          }

    - name: ctlabs.playbooks.ctlabs.setup.frr.local_facts
      when: ansible_hostname == 'ro1'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_frr.fact
        content: |
          {
            "daemons" : { 
              "enabled" : [ "bgpd", "ospfd" ],
              "profile" : "datacenter"
            },
            "router" : {
              "bgp" : {
                "local_asn"  : "65001",
                "local_ip"   : "10.8.15.1",
                "remote_ip"  : "10.8.15.2",
                "remote_asn" : "65002",
                "nets"       : ["192.168.10.0/24", "192.168.11.0/24"]
              },
              "ospf" : {
                "nets" : ["192.168.10.0/24", "192.168.113.0/30"]
              }
            }
          }

    - name: ctlabs.playbooks.ctlabs.setup.frr.local_facts
      when: ansible_hostname == 'ro2'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_frr.fact
        content: |
          {
            "daemons" : { 
              "enabled" : [ "bgpd", "ospfd" ],
              "profile" : "datacenter"
            },
            "router" : {
              "bgp" : {
                "local_asn"  : "65002",
                "local_ip"   : "10.8.15.2",
                "remote_ip"  : "10.8.15.1",
                "remote_asn" : "65001",
                "nets"       : ["192.168.20.0/24", "192.168.23.0/24"]
              },
              "ospf" : {
                "nets" : ["192.168.20.0/24", "192.168.21.0/24", "192.168.124.0/30"]
              }
            }
          }

    - name: ctlabs.playbooks.ctlabs.setup.frr.local_facts
      when: ansible_hostname == 'ro3'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_frr.fact
        content: |
          {
            "daemons" : { 
              "enabled" : [ "ospfd" ]
            },
            "router" : {
              "ospf" : {
                "nets" : ["192.168.11.0/24", "192.168.12.0/24", "192.168.113.0/30"]
              }
            }
          }

    - name: ctlabs.playbooks.ctlabs.setup.frr.local_facts
      when: ansible_hostname == 'ro4'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_frr.fact
        content: |
          {
            "daemons" : { 
              "enabled" : [ "ospfd" ]
            },
            "router" : {
              "ospf" : {
                "nets" : ["192.168.22.0/24", "192.168.23.0/24", "192.168.124.0/30"]
              }
            }
          }


    - name: ctlabs.playbooks.ctlabs.setup.frr.local_facts
      when: ansible_hostname == 'isp1'
      copy:
        dest: /etc/ansible/facts.d/ctlabs_frr.fact
        content: |
          {
            "daemons" : { 
              "enabled" : [ "bgpd" ],
              "profile" : "datacenter"
            }
          }



# -----------------------------------------------------------------------------
# semaphore
# -----------------------------------------------------------------------------
    
- name  : ctlabs.playbooks.ctlabs.semaphore
  hosts :
    - localhost
  tags  : semaphore
  roles :
    - roles/ctlabs_semaphore

# -----------------------------------------------------------------------------
# ctlabs_ca
# -----------------------------------------------------------------------------
    
- name  : ctlabs.playbooks.ctlabs.ca
  hosts : all
  tags  : ca
  roles :
    - roles/ctlabs_ca

# -----------------------------------------------------------------------------
# ctlabs_openvpn
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.openvpn
  hosts :
    - ro1
    - ro2
  tags  : openvpn
  roles :
    - roles/ctlabs_openvpn

# -----------------------------------------------------------------------------
# ctlabs_frr
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.frr
  hosts :
    - ro1
    - ro2
    - ro3
    - ro4
  tags  : frr
  roles :
    - roles/ctlabs_frr

# -----------------------------------------------------------------------------
# ctlabs_bind
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.bind
  hosts :
    - ns1
    - ns2
  tags  : bind
  roles :
    - roles/ctlabs_bind

# -----------------------------------------------------------------------------
# ctlabs_smbadc
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.smbadc
  hosts :
    - dc1
    - dc2
  tags  : smbadc
  roles :
    - roles/ctlabs_smbadc

# -----------------------------------------------------------------------------
# ctlabs_sssd
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.sssd
  hosts : hosts
  tags  : sssd
  roles :
    - roles/ctlabs_sssd

# -----------------------------------------------------------------------------
# ctlabs_slapd
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.slapd
  hosts :
    - slapd1
    - slapd2
  tags  : slapd
  roles :
    - roles/ctlabs_slapd

# -----------------------------------------------------------------------------
# ctlabs_haproxy
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.haproxy
  hosts :
    - slapd1
    - slapd2
  tags  : haproxy
  roles :
    - roles/ctlabs_haproxy

# -----------------------------------------------------------------------------
# ctlabs_httpd
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.httpd
  hosts :
    - www1
    - www2
  tags  : httpd
  roles :
    - roles/ctlabs_httpd

# -----------------------------------------------------------------------------
# ctlabs_syslog
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.syslog
  hosts :
    - ns1
  tags  : syslog
  roles :
    - roles/ctlabs_syslog

# -----------------------------------------------------------------------------
# ctlabs_prometheus
# -----------------------------------------------------------------------------
- name   : ctlabs.playbooks.ctlabs.prometheus
  hosts  :
    - prometheus
  tags   : prometheus
  roles  :
    - roles/ctlabs_prometheus

# -----------------------------------------------------------------------------
# ctlabs_grafana
# -----------------------------------------------------------------------------
- name   : ctlabs.playbooks.ctlabs.grafana
  hosts  :
    - grafana
  tags   : grafana
  roles :
    - roles/ctlabs_grafana

# -----------------------------------------------------------------------------
# ctlabs_node_exporter
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.node_exporter
  hosts :
    - hosts
  tags  : node_exporter
  roles :
    - roles/ctlabs_node_exporter

# -----------------------------------------------------------------------------
# ctlabs_mimir
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.mimir
  hosts :
    - mimir
  tags  : mimir
  roles :
    - roles/ctlabs_mimir

# -----------------------------------------------------------------------------
# ctlabs_promtail
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.promtail
  hosts :
    - hosts
  tags  : promtail
  roles :
    - roles/ctlabs_promtail

# -----------------------------------------------------------------------------
# ctlabs_loki
# -----------------------------------------------------------------------------
- name  : ctlabs.playbooks.ctlabs.loki
  hosts :
    - loki
  tags  : loki
  roles :
    - roles/ctlabs_loki

