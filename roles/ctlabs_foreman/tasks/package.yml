---

# ------------------------------------------------------------------------------
# File        : ctlabs-ansible/roles/ctlabs_foreman/tasks/package.yml
# Description : packages
# ------------------------------------------------------------------------------

#
# RedHat
#
- name: ctlabs_foreman.tasks.package.redhat
  when: ctg_os_family == 'redhat'
  block:
    - name: ctlabs_foreman.tasks.package.redhat.pkg.install
      dnf:
        name : "{{ item.url if item.url is defined else item.name }}"
        disable_gpg_check: true
      loop     : "{{ ctlabs_foreman.defaults.pkgs[ctg_os_family] }}"
      register : result
      until    : result is success


- name: ctlabs_foreman.tasks.package.server.plugins
  when: ctlabs_foreman_role == 'server'
  vars:
    ansible_python_interpreter: /usr/sbin/ip vrf exec default /usr/bin/python3
  command: |
    {{ ctlabs_foreman.defaults.install.cmd }} -s -S {{ ctlabs_foreman_scenario }} \
    --foreman-initial-admin-username {{ ctlabs_foreman.defaults.install.web.user }} \
    --foreman-initial-admin-password {{ ctlabs_foreman.defaults.install.web.pass }} \
    {{ ctlabs_foreman.defaults.install.server.flags }}
  register: output


- debug: "msg={{ output }}"


- name: ctlabs_foreman.tasks.package.proxy.plugins
  when: ctlabs_foreman_role in [ 'server' ]  #, 'proxy' ]
  vars:
    ansible_python_interpreter: /usr/sbin/ip vrf exec default /usr/bin/python3
  command: |
    {{ ctlabs_foreman.defaults.install.cmd }} -s -S {{ ctlabs_foreman_scenario }} \
    {{ ctlabs_foreman.defaults.install.proxy.flags }}
  register: output

- debug: "msg={{ output }}"