---

# ------------------------------------------------------------------------------
# File        : ctlabs-ansible/roles/ctlabs_ca/tasks/certs.yml
# Description : create new certs
# ------------------------------------------------------------------------------

# 
# Certificates
#
- name: ctlabs_ca.tasks.certs.config.prepare
  when        : inventory_hostname != 'localhost'
  delegate_to : localhost
  template    :
    src  : "{{ ctlabs_ca.defaults.config.certs.template }}"
    dest : "{{ ctlabs_ca.defaults.config.dir }}/{{ ansible_hostname }}.{{ ctlabs_ca.defaults.config.domain }}.cnf"

- name: ctlabs_ca.tasks.certs.create
  when        : inventory_hostname != 'localhost'
  delegate_to : localhost
  script      : 
    cmd   : "files/create_server_cert.sh {{ ansible_hostname }}.{{ ctlabs_ca.defaults.config.domain }}.cnf"
    chdir : "{{ ctlabs_ca.defaults.config.dir }}"
  register: "cert_create_output"

- name: ctlabs_ca.tasks.certs.copy
  when : inventory_hostname != 'localhost'
  copy: 
    src : "{{ item }}"
    dest: /tmp/
  loop:
    -  "{{ ctlabs_ca.defaults.config.dir }}/{{ ctlabs_ca.defaults.config.ca.name }}.crt"
    -  "{{ ctlabs_ca.defaults.config.dir }}/{{ ansible_hostname }}.{{ ctlabs_ca.defaults.config.domain }}.crt"
    -  "{{ ctlabs_ca.defaults.config.dir }}/{{ ansible_hostname }}.{{ ctlabs_ca.defaults.config.domain }}.key"
    -  "{{ ctlabs_ca.defaults.config.dir }}/{{ ansible_hostname }}.{{ ctlabs_ca.defaults.config.domain }}.prv"

