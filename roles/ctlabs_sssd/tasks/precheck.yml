---

# ------------------------------------------------------------------------------
# File        : ctlabs-ansible/roles/ctlabs_sssd/tasks/precheck.yml
# Description : prechecks
# ------------------------------------------------------------------------------

- name: ctlabs_sssd.tasks.precheck
  block:
    - name: ctlabs_sssd.tasks.precheck.os.supported
      assert:
        that     : os is in ctlabs_sssd.os
        fail_msg : "OS[{{os}}] is not supported!"
  rescue:
    - name: ctlabs_sssd.tasks.precheck.skip.unsupported
      meta: end_host

- name: ctlabs_sssd.tasks.precheck.computer.domain.joined
  set_fact:
    ctlabs_sssd_domain_joined: "{{ True if (lookup('pipe', '/usr/sbin/realm list -v')|split('\n'))[0] == ctlabs_sssd.defaults.config.dc.domain else False }}"

- name: ctlabs_sssd.tasks.precheck.dc.ad_server
  set_fact:
    ctlabs_sssd_ad_server: "{{ ctlabs_sssd.defaults.config.dc.hosts | shuffle }}"

# Get Credentials via prompt
- pause:
    prompt : "Enter domain join pass"
    echo   : false
  register: dc_join_pass
  when: CTLABS_SSSD_JOINPASS_PROMPT is defined

- name: ctlabs.sssd.tasks.precheck.prompt.dc_join.credentials
  when: CTLABS_SSSD_JOINPASS_PROMPT is defined
  set_fact:
    ctlabs_sssd_dc_join_pass: "{{ dc_join_pass.user_input }}"

#- debug: "msg=ctlabs_sssd_dc_join_pass={{ ctlabs_sssd_dc_join_pass }}"

# echo -en ansible_nodename | openssl sha512 | awk '{print toupper(substr($2, 11, 5)) }'
- name: ctlabs_sssd.tasks.precheck.computer_name
  set_fact:
    ctlabs_sssd_computer_name: "{{ (ansible_hostname[:8] + '-' + ctlabs_env[:1] + ( ansible_fqdn|hash('sha512') )[10:15])|upper }}"

- debug: "msg=ctlabs_sssd_computer_name={{ ctlabs_sssd_computer_name}}"

