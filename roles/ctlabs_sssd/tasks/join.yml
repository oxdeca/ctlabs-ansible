---

# ------------------------------------------------------------------------------
# File        : ctlabs-ansible/roles/ctlabs_sssd/tasks/join.yml
# Description : join domain
# ------------------------------------------------------------------------------

- name: ctlabs_sssd.tasks.join.adcli.available
  stat:
    path: /usr/sbin/adcli
  register: adcli_available

#- debug: "msg={{ adcli_available }}"

- name: ctlabs_sssd.tasks.join.dc.realm
  when: not ctlabs_sssd_domain_joined
  expect:
    command: "ip vrf exec default realm join -U {{ ctlabs_sssd.defaults.config.dc.join.user }}@{{ ctlabs_sssd.defaults.config.dc.realm }} --membership-software adcli --computer-name {{ (ansible_hostname|truncate(10)) +  '-'  + 'random' }} {{ ctlabs_sssd.defaults.config.dc.domain }}"
    responses:
      (?i)password: "{{ ctlabs_sssd_dc_join_pass | default(ctlabs_sssd.defaults.config.dc.join.pass) }}"

- name: ctlabs_sssd.tasks.join.config.sssd
  template:
    owner: "{{ ctlabs_sssd.defaults.config.sssd.user     }}"
    group: "{{ ctlabs_sssd.defaults.config.sssd.group     }}"
    mode : "{{ ctlabs_sssd.defaults.config.sssd.mode     }}"
    src  : "{{ ctlabs_sssd.defaults.config.sssd.template }}"
    dest : "{{ ctlabs_sssd.defaults.config.sssd.file     }}"
  notify: ctlabs_sssd.handlers.service.restart
